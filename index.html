<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parse a schedule</title>
    <style>
        #loading {
            display: none;
            color: blue;
        }
    </style>
</head>

<body>
    <h1>Upload a schedule Image</h1>
    <div id="loading">Loading, please wait...</div>
    <form id="upload-form">
        <input type="file" id="image-input" accept="image/png, image/jpeg">
        <br></br>
        <label for="api-key-input">API key:</label>
        <input type="text" id="api-key-input" name="Add your api key" accept="text">
        <br></br>
        <button type="submit">Generate</button>
    </form>
    <pre id="response-output"></pre>

    <script src="https://cdn.jsdelivr.net/gh/nwcell/ics.js/ics.min.js"></script>
    <script>
        const daysOfWeek = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
        function getDescriptionForEvent(event) {
            return `${event.name} happening on ${event.location} on ${event.day} at ${event.time}`
        }
        function getDayForWeekDay(weekday) {
            const now = new Date();
            const currentDayIndex = now.getDay();
            const targetDayIndex = daysOfWeek.indexOf(weekday);

            let daysUntilNextWeekday;

            if (targetDayIndex >= currentDayIndex) {
                daysUntilNextWeekday = targetDayIndex - currentDayIndex;
            } else {
                daysUntilNextWeekday = 7 - (currentDayIndex - targetDayIndex);
            }

            const nextWeekday = new Date();
            nextWeekday.setDate(now.getDate() + daysUntilNextWeekday);
            nextWeekday.setHours(0, 0, 0, 0);  // Set time to midnight

            return nextWeekday;
        }
        function getDateForEvent(event, start = true) {
            // TODO handle edge cases
            let date;
            if (daysOfWeek.includes(event.day)) {
                date = getDayForWeekDay(event.day)
            }
            else {
                let dateSplit = event.day.split("/");
                date = new Date(`${dateSplit[1]}/${dateSplit[0]}/${dateSplit[2]}`); // switch day and month to be compatible with JS Date
            }
            if (event.time) {
                const regex = /(\d{2}):(\d{2})-(\d{2}):(\d{2})/;
                // Match the pattern against the time string
                const match = event.time.match(regex);

                if (match) {
                    const startHour = match[1];
                    const startMinute = match[2];
                    const endHour = match[3];
                    const endMinute = match[4];
                    if (start) {
                        date.setHours(startHour);
                        date.setMinutes(startMinute);
                    }
                    else {
                        date.setHours(endHour);
                        date.setMinutes(endMinute);
                        if (endHour < startHour) {
                            date.setDate(date.getDate() + 1);
                        }
                    }
                } else {
                    console.log("The string does not match the expected format.");
                }
            }
            return date;
        }
        document.getElementById('upload-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const apiKey = document.getElementById('api-key-input').value;

            if (!apiKey) {
                alert('Please set your API key.');
            }

            const fileInput = document.getElementById('image-input');
            const loadingIndicator = document.getElementById('loading');
            const file = fileInput.files[0];

            if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                const reader = new FileReader();

                reader.onload = async function (e) {
                    const base64Image = e.target.result.split(',')[1]; // Extract base64 data
                    // const jsonResponse = {
                    //     "events": [
                    //         {
                    //             "name": "Will Gustin",
                    //             "day": "wednesday",
                    //             "time": "18:00-19:00",
                    //             "stage": "Apuro"
                    //         },
                    //         {
                    //             "name": "Dasha Rush",
                    //             "day": "friday",
                    //             "time": "23:00-02:00",
                    //             "stage": "Praia"
                    //         },
                    //         {
                    //             "name": "Bruno J",
                    //             "day": "saturday",
                    //             "time": "18:00-19:00",
                    //             "stage": "Cochilo"
                    //         },
                    //         {
                    //             "name": "Oliver Weiss",
                    //             "day": "sunday",
                    //             "time": "16:00-18:00",
                    //             "stage": "Praia"
                    //         },
                    //         {
                    //             "name": "Renato Ratier",
                    //             "day": "friday",
                    //             "time": "22:00-04:00",
                    //             "stage": "Floresta"
                    //         }
                    //     ]
                    // }
                    try {
                        loadingIndicator.style.display = 'block';
                        const response = await fetch('https://7brdfeocmf.execute-api.eu-west-1.amazonaws.com/prod/parse/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': apiKey,
                            },
                            body: JSON.stringify({ Base64_image: base64Image })
                        })
                        if (response.ok) {
                            const jsonResponse = await response.json();
                            const events = jsonResponse.events; // Assuming the response has an array of events
                            const cal = ics();
                            jsonResponse.events.forEach(event => {
                                cal.addEvent(
                                    event.name,
                                    getDescriptionForEvent(event),
                                    event.stage,
                                    getDateForEvent(event),
                                    getDateForEvent(event, false)
                                );
                            });

                            const icsFile = cal.build();
                            const blob = new Blob([icsFile], { type: 'text/calendar' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'events.ics';
                            a.click();
                            URL.revokeObjectURL(url);  // Clean up the object URL
                        } else {
                            document.getElementById('response-output').textContent = `Error: ${response.status} ${response.statusText} - ${errorMessage}`;
                        };
                    } catch (error) {
                        document.getElementById('response-output').textContent = `Error: ${error}`;
                    } finally {
                        loadingIndicator.style.display = 'none';
                    }
                };

                reader.readAsDataURL(file);
            } else {
                alert('Please upload a JPEG image.');
            }
        });
    </script>
</body>
</html>
